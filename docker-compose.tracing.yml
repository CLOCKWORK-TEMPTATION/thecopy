version: '3.8'

services:
  # Jaeger All-in-One: Includes collector, query service, and UI
  jaeger:
    image: jaegertracing/all-in-one:1.65
    container_name: theeeecopy-jaeger
    ports:
      # Jaeger UI
      - "16686:16686"
      # OTLP gRPC receiver
      - "4317:4317"
      # OTLP HTTP receiver
      - "4318:4318"
      # Jaeger Thrift compact
      - "6831:6831/udp"
      # Jaeger Thrift binary
      - "6832:6832/udp"
      # Jaeger HTTP collector
      - "14268:14268"
      # Health check
      - "14269:14269"
    environment:
      # Storage configuration
      COLLECTOR_OTLP_ENABLED: "true"
      # Query service configuration
      QUERY_BASE_PATH: /
      # UI configuration
      SPAN_STORAGE_TYPE: memory
      # Memory limits for in-memory storage
      MEMORY_MAX_TRACES: 10000
      # Log level
      LOG_LEVEL: info
    networks:
      - tracing-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Jaeger with persistent storage using Elasticsearch
  # Uncomment this section and comment out the jaeger service above
  # if you want persistent storage
  
  # elasticsearch:
  #   image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
  #   container_name: theeeecopy-elasticsearch
  #   environment:
  #     - discovery.type=single-node
  #     - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
  #     - xpack.security.enabled=false
  #   ports:
  #     - "9200:9200"
  #   volumes:
  #     - elasticsearch-data:/usr/share/elasticsearch/data
  #   networks:
  #     - tracing-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9200/_cluster/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5

  # jaeger-with-storage:
  #   image: jaegertracing/all-in-one:1.65
  #   container_name: theeeecopy-jaeger
  #   depends_on:
  #     elasticsearch:
  #       condition: service_healthy
  #   ports:
  #     - "16686:16686"
  #     - "4317:4317"
  #     - "4318:4318"
  #     - "6831:6831/udp"
  #     - "6832:6832/udp"
  #     - "14268:14268"
  #   environment:
  #     COLLECTOR_OTLP_ENABLED: "true"
  #     SPAN_STORAGE_TYPE: elasticsearch
  #     ES_SERVER_URLS: http://elasticsearch:9200
  #     ES_TAGS_AS_FIELDS_ALL: "true"
  #     LOG_LEVEL: info
  #   networks:
  #     - tracing-network
  #   restart: unless-stopped

networks:
  tracing-network:
    driver: bridge

# Uncomment if using Elasticsearch
# volumes:
#   elasticsearch-data:
#     driver: local
